var wrappers={object:{isVisible:function(e){return config_ol.html_page_elments.use_jquery?e.is(":visible"):"none"!=e.style.display},getObjectFromDOMbySelector:function(e){return config_ol.html_page_elments.use_jquery?$(e):document.querySelector(e)},getChildrenByTag:function(e,t){return config_ol.html_page_elments.use_jquery?e.children(t):e.getElementsByTagName(t)},setInnerHtmlValue:function(e,t){config_ol.html_page_elments.use_jquery?e.html(t):e.innerHTML=t},empty:function(e){if(config_ol.html_page_elments.use_jquery)e.empty();else for(;e.firstChild;)e.removeChild(e.firstChild)},hide:function(e){config_ol.html_page_elments.use_jquery?e.hide():e.style.display="none"},show:function(e){config_ol.html_page_elments.use_jquery?e.show():e.style.display="block"},removeChildrenByTagAndDataAttribute:function(e,t,o,l){var r=t+"["+o+'="'+l+'"]';if(config_ol.html_page_elments.use_jquery)e.children(r).remove();else for(var i=document.querySelectorAll(r),a=0;a<i.length;a++)e.removeChild(i[a])}},dropdown:{selectItemByValue:function(e,t){if(config_ol.html_page_elments.use_jquery)config_ol.html_page_elments.use_bootstrap_select?e.selectpicker("val",t):e.val(t);else for(var o=0;o<e.options.length;o++)if(e.options[o].value==t){e.selectedIndex=e.options[o].index;break}},selectFirstItem:function(e){config_ol.html_page_elments.use_jquery?(e.prop("selectedIndex",0).change(),config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("refresh")):e.hasChildNodes()?e.selectedIndex=0:e.selectedIndex=-1},addItem:function(e,t,o){if(config_ol.html_page_elments.use_jquery){var l=e.prop("options");l[l.length]=t,config_ol.html_page_elments.use_bootstrap_select&&o&&e.selectpicker("refresh")}else e.add(t)},getSelectedValue:function(e){return config_ol.html_page_elments.use_jquery?e.children("option").filter(":selected").val():e.options[e.selectedIndex].value},empty:function(e){config_ol.html_page_elments.use_jquery?(e.empty(),config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("render")):wrappers.object.empty(e)},hide:function(e){config_ol.html_page_elments.use_jquery?(e.hide(),config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("hide")):wrappers.object.hide(e)},show:function(e){config_ol.html_page_elments.use_jquery?(e.show(),config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("show")):wrappers.object.show(e)},refreshAfterUpdate:function(e){config_ol.html_page_elments.use_jquery&&config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("refresh")}},html_list:{addItem:function(e,t){config_ol.html_page_elments.use_jquery?e.append(t):e.appendChild(t)}},event:{addClickEventListener:function(e,t){config_ol.html_page_elments.use_jquery?e.click(t):e.addEventListener("click",t)},addChangeEventListener:function(e,t){config_ol.html_page_elments.use_jquery?e.change(t):e.addEventListener("change",t)}}},commonUtils={common:{isUndefinedVar:function(e){return void 0===e||null==e},isArray:function(e){return!!e&&e.constructor===Array},isObject:function(e){return!!e&&e.constructor===Object},isString:function(e){return!!e&&e.constructor===String},isNumber:function(e){return!!e&&e.constructor===Number},compareIntegersAndLetters:function(e,t){var o=0;if(null==e||null==t)null==e&&null==t?o=0:null!=e&&null==t?o=1:null==e&&null!=t&&(o=-1);else{var l=parseInt(e),r=parseInt(t);isNaN(l)&&isNaN(r)?o=e.localeCompare(t):isNaN(l)&&!isNaN(r)?o=-1:!isNaN(l)&&isNaN(r)?o=1:isNaN(l)||isNaN(r)||(o=l-r)}return o}},array:{remove_duplicates:function(e){for(var t={},o=[],l=e.length,r=0,i=0;i<l;i++){var a=e[i];1!==t[a]&&(t[a]=1,o[r++]=a)}return o}},string:{isEmptyOrNull:function(e){return!!commonUtils.common.isUndefinedVar(e)||!!(commonUtils.common.isString(e)&&e.trim().length<1)},trim:function(e){for(;" "==e.substring(0,1);)e=e.substring(1,e.length);for(;" "==e.substring(e.length-1,e.length);)e=e.substring(0,e.length-1);return e},pad_string:function(e,t){return commonUtils.common.isUndefinedVar(e)&&(e=""),commonUtils.common.isUndefinedVar(t)?null:(t+e).slice(-t.length)}},html_list:{sortItemsByAttribute:function(e,t,o){do{for(var l,r=wrappers.object.getChildrenByTag(e,t),i=!1,a=!1,n=void 0,s=0;s<r.length-1;s++){l=r[s],n=r[s+1];var c=l.getAttribute(o),_=n.getAttribute(o);if(0<commonUtils.common.compareIntegersAndLetters(c,_)){i=!0;break}}i&&null!=l&&null!=n&&(l.parentNode.insertBefore(n,l),a=!0)}while(a)}}},gisUtils={filter_type_cql:"cql",getWFSFeatures:function(e,t,o,l,r){if(r){console.log("ATTENZIONE FUNZIONE SPERIMENTALE!!!! AL MOMENTO FUNZIONA SOLO CON NODEJS"),console.log("SENZA NODEJS LA RICHIESTA PARTE MA IL SISTEMA NON SEMBRA IN GRADO DI RECUPERARE IL JSON DI RISPOSTA");var i=(new ol.format.WFS).writeGetFeature(t);fetch(e+"/wfs",{method:"POST",credentials:"same-origin",redirect:"follow",agent:null,body:(new XMLSerializer).serializeToString(i)}).then(function(e){return e.json()}).then(function(e){return o(e)})}else{var a=Object.keys(t).map(function(e){return e+"="+t[e]}).join("&");fetch(e+"/wfs?"+a,{method:"GET",headers:{}}).then(function(e){return e.json()}).then(function(e){return o(e)}).catch(function(e){return l(e)})}},getFirstFeatureFromJsonResponse:function(e){var t=void 0,o=(new ol.format.GeoJSON).readFeatures(e);return null!=o&&0<o.length&&null!=o[0]&&(t=o[0]),t},prepareIntersectWithPointFilter:function(e,t,o,l,r){return e?new ol.format.filter.Intersects(t,new ol.geom.Point([o,l]),r):"INTERSECTS("+t+" ,POINT("+o+" "+l+"))"},prepareEqualToFilter:function(e,t,o,l){null==l&&(l=!1);return e?new ol.format.filter.equalTo(t,o,l):l?t+" = '"+o+"'":t+" ILIKE '"+o+"'"},prepareLikeFilter:function(e,t,o,l){null==l&&(l=!1);return e?new ol.format.filter.like(t,o,"*",".","!",l):l?t+" LIKE '"+o+"'":t+" ILIKE '"+o+"'"},prepareInFilter:function(e,t,o){var l=void 0;return e?console.log("metoodo da implentare"):l=t+" IN ('"+o.join("', '")+"')",l},prepareWFSRequestParams:function(e,t,o,l,r,i,a,n,s,c,_){if(commonUtils.string.isEmptyOrNull(t))console.log("Attenzione, obbligatorio indicare il nome del workspace da interrogare");else if(t=commonUtils.string.trim(t),commonUtils.string.isEmptyOrNull(o))console.log("Attenzione, obbligatorio indicare la URI del workspace da interrogare");else{if(o=commonUtils.string.trim(o),!commonUtils.string.isEmptyOrNull(r)){r=commonUtils.string.trim(r);var g=void 0;g=i?{featureNS:o,featurePrefix:t,srsName:r,outputFormat:"application/json"}:{service:"WFS",version:"2.0.0",request:"GetFeature",typenames:t+":"+e,outputFormat:encodeURIComponent("application/json"),srsName:r},commonUtils.common.isUndefinedVar(a)||(i||(a=a.replace(/ /g,"+")),commonUtils.common.isUndefinedVar(n)||"cql"!=n?g.filter=a:g.cql_filter=a);var m=void 0;return commonUtils.common.isArray(l)&&0<l.length?m=l:commonUtils.common.isString(l)&&!commonUtils.string.isEmptyOrNull(l)&&(m=[l=l.trim()]),!commonUtils.common.isUndefinedVar(m)&&0<m.length&&(i?g.propertyNames=m:g.propertyName=m.join(",")),commonUtils.string.isEmptyOrNull(c)||(g.sortBy=c,commonUtils.common.isUndefinedVar(_)&&(_=!0),g.sortBy=_?g.sortBy+"+A":g.sortBy+"+D"),commonUtils.string.isEmptyOrNull(s)||(g.featureID=commonUtils.string.trim(s)),g}console.log("Attenzione, obbligatorio indicare il sistema di coordinate da utilizzare")}},getWMSLayerFromParams:function(e,t,o,l,r,i){var a=null;if(void 0===e.sourceLayers||null==e.sourceLayers||e.sourceLayers.trim().length<1)console.log("Attenzione, campo sourceLayer non definito. impossibile creare questo layer");else{void 0!==e.visible&&null!=e.visible||(e.visible=!0),void 0!==e.tiled&&null!=e.tiled||(e.tiled=!1),(void 0===e.opacity||null==e.opacity||e.opacity<0)&&(e.opacity=1),(void 0===e.format||null==e.format||e.format.trim().length<1)&&(e.format="image/png"),(void 0===e.style||null==e.style||e.style.trim().length<1)&&(e.style="");var n=o;void 0===e.workspace||null==e.workspace||e.workspace.trim().length<1||(n+="/"+e.workspace),void 0===e.serviceType||null==e.serviceType||0==e.serviceType.trim()||"wms"==e.serviceType.trim().toLowerCase()?n+="/wms":"wms-c"==e.serviceType.trim().toLowerCase()&&(n+="/gwc/service/wms");var s={LAYERS:e.sourceLayers,FORMAT:e.format,STYLES:e.style};void 0===e.filter||null==e.filter||e.filter.trim().length<1||(s.CQL_FILTER=e.filter);var c={crossOrigin:null,params:s,projection:r,url:n};i&&(c.serverType="geoserver");var _={opacity:e.opacity,extent:l,visible:e.visible};a=1==e.tiled?(_.source=new ol.source.TileWMS(c),new ol.layer.Tile(_)):(_.source=new ol.source.ImageWMS(c),new ol.layer.Image(_))}return a},getWMSLayersGroup:function(e,t,o,l,r,i,a){var n=[];if(void 0===e||null==e||e.length<1)return log("Attenzione, in getWMSLayersGroup layersParams obbligatorio. impossibile generare il layergroup"),null;(void 0===o||null==o||o.trim().length<1)&&(o=t?"Cartografia di Sfondo":"Livelli di sovrapposizione");for(var s=0;s<e.length;s++)n[s]=getWMSLayerFromParams(e[s],t,l,r,i,a);return 0<n.length?new ol.layer.Group({title:o,layers:n}):null},sortFeaturesByAttribute:function(e,r){return e.sort(function(e,t){if(null!=e&&null==t)return 1;if(null==e&&null!=t)return-1;var o=e.getProperties()[r],l=t.getProperties()[r];return commonUtils.common.compareIntegersAndLetters(o,l)})}},catastoUtils={loadAllFogli:function(e,t){var o=config_ol.layer_foglio.field_name_comune+"='"+config_ol.layer_foglio.value_comune+"' AND "+config_ol.layer_foglio.field_name_sezione+"='"+config_ol.layer_foglio.value_sezione+"' AND "+config_ol.layer_foglio.field_name_allegato+"='"+config_ol.layer_foglio.def_value_allegato+"' AND "+config_ol.layer_foglio.field_name_sviluppo+"='"+config_ol.layer_foglio.def_value_sviluppo+"'",l=config_ol.layer_foglio.field_name_foglio,r=gisUtils.prepareWFSRequestParams(config_ol.layer_foglio.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_foglio.field_name_foglio],config_ol.coord_system_code,!1,o,gisUtils.filter_type_cql,void 0,l);null==t&&(t=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,r,e,t,!1)},loadAllParticelleByFoglio:function(e,t,o){if(commonUtils.string.isEmptyOrNull(e))console.log("non riesco a recuperare il valore per foglio catastale selezionato");else{var l=config_ol.layer_particella.field_name_comune+"='"+config_ol.layer_foglio.value_comune+"' AND "+config_ol.layer_particella.field_name_sezione+"='"+config_ol.layer_foglio.value_sezione+"' AND "+config_ol.layer_particella.field_name_foglio+"='"+e+"'",r=gisUtils.prepareWFSRequestParams(config_ol.layer_particella.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_particella.field_name_foglio,config_ol.layer_particella.field_name_mappale,config_ol.layer_particella.field_name_partkey],config_ol.coord_system_code,!1,l,gisUtils.filter_type_cql,void 0,config_ol.layer_particella.field_name_mappale);null==o&&(o=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,r,t,o,!1)}},loadSelectedParticelle:function(e,t,o){if(null!=e&&0<e.length){var l=void 0;l=1==e.length?gisUtils.prepareEqualToFilter(!1,config_ol.layer_particella.field_name_partkey,e[0]):gisUtils.prepareInFilter(!1,config_ol.layer_particella.field_name_partkey,e);var r=gisUtils.prepareWFSRequestParams(config_ol.layer_particella.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_particella.field_name_geom,config_ol.layer_particella.field_name_foglio,config_ol.layer_particella.field_name_mappale,config_ol.layer_particella.field_name_partkey],config_ol.coord_system_code,!1,l,gisUtils.filter_type_cql,void 0,config_ol.layer_particella.field_name_mappale);null==o&&(o=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,r,t,o,!1)}},loadFoglioByNumero:function(e,t,o){var l=gisUtils.prepareLikeFilter(!1,config_ol.layer_foglio.field_name_foglio,e),r=gisUtils.prepareWFSRequestParams(config_ol.layer_foglio.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_foglio.field_name_geom,config_ol.layer_foglio.field_name_foglio],config_ol.coord_system_code,!1,l,gisUtils.filter_type_cql);null==o&&(o=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,r,t,o,!1)},loadFoglioByIntersectionPoint:function(e,t,o){var l=gisUtils.prepareIntersectWithPointFilter(!1,config_ol.layer_foglio.field_name_geom,e,t,config_ol.coord_system_code),r=gisUtils.prepareWFSRequestParams(config_ol.layer_foglio.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_foglio.field_name_foglio],config_ol.coord_system_code,!1,l,gisUtils.filter_type_cql);gisUtils.getWFSFeatures(config_ol.url_geoserver,r,function(e){var t=(new ol.format.GeoJSON).readFeatures(e);null!=t&&null!=t[0]&&catastoUtils.loadFoglioByNumero(t[0].getProperties()[config_ol.layer_foglio.field_name_foglio],o)},catastoUtils.onError,!1)},loadParticellaByIntersectionPoint:function(e,t,o,l){var r=gisUtils.prepareIntersectWithPointFilter(!1,config_ol.layer_particella.field_name_geom,e,t,config_ol.coord_system_code),i=gisUtils.prepareWFSRequestParams(config_ol.layer_particella.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_particella.field_name_geom,config_ol.layer_particella.field_name_foglio,config_ol.layer_particella.field_name_mappale,config_ol.layer_particella.field_name_partkey],config_ol.coord_system_code,!1,r,gisUtils.filter_type_cql);null==l&&(l=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,i,o,l,!1)},getNumeroFoglioFromPartkey:function(e){if(null!=e&&0<e.length)return e.substring(5,9).trim()},getValoreMappaleFromPartkey:function(e){if(null!=e&&0<e.length)return e.substring(10,15).trim()},onError:function(e){console.log("request failed",e)}};function createMapLayers(){var e={layer_perimetro_comunale:void 0,layer_carto_base:void 0,tms:void 0,layer_group:void 0,layer_catasto_fogli:void 0,layer_catasto_particelle:void 0,layer_vett_foglio:void 0,layer_vett_particelle:void 0};return e.layer_perimetro_comunale=gisUtils.getWMSLayerFromParams({sourceLayers:config_ol.gs_default_workspace_name+":"+config_ol.baselayers_name.layer_name_perimetrocom,workspace:config_ol.gs_default_workspace_name,serviceType:"wms",visible:!0,tiled:!1,opacity:1,format:"image/png"},!0,config_ol.url_geoserver,config_ol.territory_extent,config_ol.coord_system_code,!0),e.layer_carto_base=gisUtils.getWMSLayerFromParams({sourceLayers:config_ol.gs_default_workspace_name+":"+config_ol.baselayers_name.layer_name_viecivici,workspace:config_ol.gs_default_workspace_name,serviceType:"wms",visible:!0,tiled:!1,opacity:.7,format:"image/png"},!0,config_ol.url_geoserver,config_ol.territory_extent,config_ol.coord_system_code,!0),e.tms=new ol.layer.Tile({preload:1,source:new ol.source.TileImage({crossOrigin:null,extent:config_ol.tms_extent,projection:config_ol.projection,tileGrid:new ol.tilegrid.TileGrid({extent:config_ol.tms_extent,origin:config_ol.tms_origin,resolutions:config_ol.tms_resolutions}),tileUrlFunction:function(e){if(null!==e){var t=e[0],o=e[1],l=e[2];return config_ol.tms_base_url+config_ol.tms_last_year_geo+"/"+t+"/"+o+"/"+l+"."+config_ol.tms_image_extension}}})}),e.layer_catasto_fogli=gisUtils.getWMSLayerFromParams({sourceLayers:config_ol.gs_default_workspace_name+":"+config_ol.layer_foglio.layer_name,workspace:config_ol.gs_default_workspace_name,style:config_ol.layer_foglio.style,serviceType:"wms",visible:!0,tiled:!1,opacity:1,format:"image/png"},!0,config_ol.url_geoserver,config_ol.territory_extent,config_ol.coord_system_code,!0),e.layer_catasto_particelle=gisUtils.getWMSLayerFromParams({sourceLayers:config_ol.gs_default_workspace_name+":"+config_ol.layer_particella.layer_name,workspace:config_ol.gs_default_workspace_name,style:config_ol.layer_particella.style,serviceType:"wms",visible:!1,tiled:!1,opacity:1,format:"image/png"},!0,config_ol.url_geoserver,config_ol.territory_extent,config_ol.coord_system_code,!0),e.layer_vett_foglio=new ol.layer.Vector({source:new ol.source.Vector,title:"Foglio Selezionato",style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(153, 0, 0, 0.2)"}),stroke:new ol.style.Stroke({color:"#990000",width:3})})}),e.layer_vett_particelle=new ol.layer.Vector({source:new ol.source.Vector,title:"Particelle Selezionate",style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(35, 209, 99, 0.2)"}),stroke:new ol.style.Stroke({color:"#7BEF51",width:3})})}),e}function initializeFormAndMap(e){if(resetHTMLForm(!0),populateFogliDropDownList(e),null!=arrayParticelleInput&&0<arrayParticelleInput.length&&(navigation.seLectedFoglio=catastoUtils.getNumeroFoglioFromPartkey(arrayParticelleInput[0]),null!=navigation.seLectedFoglio&&(wrappers.dropdown.selectItemByValue(html_fogli_DropDownList,navigation.seLectedFoglio),catastoUtils.loadFoglioByNumero(navigation.seLectedFoglio,displaySelectedFoglioOnMap),wrappers.event.addClickEventListener(html_buttonConfirm,onConfirmSelection),wrappers.event.addClickEventListener(html_buttonReset,onResetApplication),wrappers.event.addChangeEventListener(html_fogli_DropDownList,onChangeFogliDropDown),wrappers.event.addChangeEventListener(html_mappali_DropDownList,onChangeParticelleDropDown),navigation.selectedParticelle=commonUtils.array.remove_duplicates(arrayParticelleInput),isAllParticelleOfSameFoglio()))){catastoUtils.loadSelectedParticelle(navigation.selectedParticelle,function(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&0<t.length){layersProgetto.layer_vett_particelle.getSource().clear(),layersProgetto.layer_vett_particelle.getSource().addFeatures(t);for(var o=0;o<t.length;o++){var l=t[o].getProperties();wrappers.html_list.addItem(html_selectedParticelleHtmlList,createPartKeyHtmlListElement(l))}commonUtils.html_list.sortItemsByAttribute(html_selectedParticelleHtmlList,"li",config_ol.html_page_elments.form_list_element_partnumber),wrappers.object.show(html_selectionBlockDiv),wrappers.object.show(html_buttonConfirm),map.getView().fit(layersProgetto.layer_vett_particelle.getSource().getExtent())}})}}function setFogliDropDownSelectedValue(){wrappers.dropdown.hide(html_mappali_DropDownList),wrappers.dropdown.show(html_mappali_DropDownList_empty),catastoUtils.loadAllParticelleByFoglio(navigation.seLectedFoglio,populateParticelleDropDownList),wrappers.dropdown.getSelectedValue(html_fogli_DropDownList)!=navigation.seLectedFoglio&&wrappers.dropdown.selectItemByValue(html_fogli_DropDownList,navigation.seLectedFoglio)}function isAllParticelleOfSameFoglio(){for(var e=!1,t=0;t<navigation.selectedParticelle.length;t++){if(catastoUtils.getNumeroFoglioFromPartkey(navigation.selectedParticelle[t])!=navigation.seLectedFoglio){e=!0;break}}return!e}function isParticellaInFoglioCorretto(e){return e[config_ol.layer_particella.field_name_foglio]==navigation.seLectedFoglio}function resetHTMLForm(e){wrappers.object.empty(html_selectedFoglioTitolo),wrappers.object.empty(html_selectedParticelleHtmlList),wrappers.object.empty(html_mappali_DropDownList),wrappers.dropdown.hide(html_mappali_DropDownList),wrappers.dropdown.show(html_mappali_DropDownList_empty),wrappers.object.hide(html_selectionBlockDiv),e||wrappers.dropdown.selectFirstItem(html_fogli_DropDownList)}function resetNavigation(){navigation.intersectionPoint=void 0,navigation.seLectedFoglio=void 0,navigation.selectedParticelle=[]}function resetMap(){layersProgetto.layer_vett_foglio.getSource().clear(),layersProgetto.layer_vett_particelle.getSource().clear();var e=layersProgetto.layer_catasto_particelle.getSource().getParams();e.CQL_FILTER="1=2",layersProgetto.layer_catasto_particelle.getSource().updateParams(e),map.getView().fit(config_ol.tms_extent)}function onMapClick(e){navigation.intersectionPoint=e.coordinate,void 0===navigation.seLectedFoglio?catastoUtils.loadFoglioByIntersectionPoint(navigation.intersectionPoint[0],navigation.intersectionPoint[1],displaySelectedFoglioOnMap):catastoUtils.loadParticellaByIntersectionPoint(navigation.intersectionPoint[0],navigation.intersectionPoint[1],addRemoveParticellaFromSelectionList)}function onChangeFogliDropDown(e){var t=e.target.value;resetNavigation(),resetHTMLForm(!0),resetMap(),catastoUtils.loadFoglioByNumero(t,displaySelectedFoglioOnMap)}function onChangeParticelleDropDown(e){var t=e.target.value;if(navigation.selectedParticelle.includes(t));else{var o=catastoUtils.getNumeroFoglioFromPartkey(t),l=wrappers.dropdown.getSelectedValue(html_fogli_DropDownList);if(o==l){catastoUtils.loadSelectedParticelle([t],function(e){var t=gisUtils.getFirstFeatureFromJsonResponse(e),o=t.getProperties();null!=t&&isParticellaInFoglioCorretto(o)&&commonAddParticellaFeatureToVectorLayer(t,!0)})}else console.log("errore imprevisto. la paricella richiesta ("+t+") non fa parte del foglio selezionato ("+l+").")}}function onConfirmSelection(){isAllParticelleOfSameFoglio()?(navigation.selectedParticelle=commonUtils.array.remove_duplicates(navigation.selectedParticelle),navigation.selectedParticelle=navigation.selectedParticelle.sort(function(e,t){if(null!=e&&null==t)return 1;if(null==e&&null!=t)return-1;var o=catastoUtils.getValoreMappaleFromPartkey(e),l=catastoUtils.getValoreMappaleFromPartkey(t);return commonUtils.common.compareIntegersAndLetters(o,l)}),callBack(navigation.selectedParticelle)):console.log("Attenzione, alcune delle particelle selezionate non appartengono al foglio selezionato")}function onResetApplication(){resetNavigation(),resetHTMLForm(!1),resetMap()}function createPartKeyHtmlListElement(e){var t=document.createElement("li");t.setAttribute("class","list-group-item d-flex justify-content-between align-items-center");var o=document.createElement("span");o.setAttribute("class","badge badge-danger badge-pill");var l=document.createElement("a");l.setAttribute("href","#"),l.setAttribute("class","ol-closer"),l.setAttribute("onclick","eliminaPartKeyDaSelezione('"+e[config_ol.layer_particella.field_name_partkey]+"')"),o.appendChild(l);var r=document.createElement("span");r.setAttribute("class","particella_value_container");var i=document.createTextNode(e[config_ol.layer_particella.field_name_mappale]);return r.appendChild(i),t.appendChild(r),t.appendChild(o),t.setAttribute(config_ol.html_page_elments.form_list_element_partkey,e[config_ol.layer_particella.field_name_partkey]),t.setAttribute(config_ol.html_page_elments.form_list_element_partnumber,e[config_ol.layer_particella.field_name_mappale]),t}function setTitoloFoglioSelezionato(e){wrappers.object.setInnerHtmlValue(html_selectedFoglioTitolo,e)}function populateFogliDropDownList(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&0<t.length){t=gisUtils.sortFeaturesByAttribute(t,config_ol.layer_foglio.field_name_foglio),wrappers.dropdown.empty(html_fogli_DropDownList);var o=new Option(" - fogli - ","",!0,!0);wrappers.dropdown.addItem(html_fogli_DropDownList,o,!1);for(var l=0;l<t.length;l++){var r=t[l].getProperties(),i=r[config_ol.layer_foglio.field_name_foglio],a=r[config_ol.layer_foglio.field_name_foglio],n=new Option(a,i,!1,!1);wrappers.dropdown.addItem(html_fogli_DropDownList,n,!1)}wrappers.dropdown.refreshAfterUpdate(html_fogli_DropDownList)}}function populateParticelleDropDownList(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&0<t.length){t=gisUtils.sortFeaturesByAttribute(t,config_ol.layer_particella.field_name_mappale),wrappers.dropdown.empty(html_mappali_DropDownList);var o=new Option(" - mappali - ","",!0,!0);wrappers.dropdown.addItem(html_mappali_DropDownList,o,!1);for(var l=0;l<t.length;l++){var r=t[l].getProperties(),i=r[config_ol.layer_particella.field_name_partkey],a=r[config_ol.layer_particella.field_name_mappale],n=new Option(a,i,!1,!1);wrappers.dropdown.addItem(html_mappali_DropDownList,n,!1)}wrappers.dropdown.refreshAfterUpdate(html_mappali_DropDownList),wrappers.dropdown.show(html_mappali_DropDownList),wrappers.dropdown.hide(html_mappali_DropDownList_empty)}}function displaySelectedFoglioOnMap(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&null!=t[0]){navigation.seLectedFoglio=t[0].getProperties()[config_ol.layer_foglio.field_name_foglio],setTitoloFoglioSelezionato("Foglio "+navigation.seLectedFoglio),wrappers.object.show(html_selectionBlockDiv);for(var o=0;o<t.length;o++){t[o].getProperties()[config_ol.layer_foglio.field_name_foglio]==navigation.seLectedFoglio&&layersProgetto.layer_vett_foglio.getSource().addFeature(t[o])}config_ol.layer_foglio.fit_selected_area_when_change&&map.getView().fit(layersProgetto.layer_vett_foglio.getSource().getExtent());var l=layersProgetto.layer_catasto_particelle.getSource().getParams();l.CQL_FILTER=config_ol.layer_particella.field_name_foglio+"='"+navigation.seLectedFoglio+"'",layersProgetto.layer_catasto_particelle.getSource().updateParams(l),layersProgetto.layer_catasto_particelle.setVisible(!0),setFogliDropDownSelectedValue()}}function addRemoveParticellaFromSelectionList(e){if(firstFeature=gisUtils.getFirstFeatureFromJsonResponse(e),null!=firstFeature){var t=firstFeature.getProperties();if(isParticellaInFoglioCorretto(t)){var o=t[config_ol.layer_particella.field_name_partkey];-1<navigation.selectedParticelle.indexOf(o)?eliminaPartKeyDaSelezione(o):commonAddParticellaFeatureToVectorLayer(firstFeature,!1)}}}function commonAddParticellaFeatureToVectorLayer(e,t){var o=e.getProperties(),l=o[config_ol.layer_particella.field_name_partkey];(navigation.selectedParticelle.push(l),wrappers.object.isVisible(html_buttonConfirm)&&wrappers.object.show(html_buttonConfirm),wrappers.html_list.addItem(html_selectedParticelleHtmlList,createPartKeyHtmlListElement(o)),commonUtils.html_list.sortItemsByAttribute(html_selectedParticelleHtmlList,"li",config_ol.html_page_elments.form_list_element_partnumber),layersProgetto.layer_vett_particelle.getSource().addFeature(e),config_ol.layer_particella.fit_selected_area_when_change&&map.getView().fit(layersProgetto.layer_vett_particelle.getSource().getExtent()),t)||wrappers.dropdown.getSelectedValue(html_mappali_DropDownList)!=l&&wrappers.dropdown.selectItemByValue(html_mappali_DropDownList,l)}function eliminaPartKeyDaSelezione(t){var e=navigation.selectedParticelle.indexOf(t);if(-1<e){var o=layersProgetto.layer_vett_particelle.getSource().forEachFeature(function(e){if(e.getProperties()[config_ol.layer_particella.field_name_partkey]==t)return e});null!=o&&(layersProgetto.layer_vett_particelle.getSource().removeFeature(o),navigation.selectedParticelle.splice(e,1),config_ol.layer_particella.fit_selected_area_when_change&&(0<navigation.selectedParticelle.length?map.getView().fit(layersProgetto.layer_vett_particelle.getSource().getExtent()):map.getView().fit(layersProgetto.layer_vett_foglio.getSource().getExtent()))),wrappers.object.removeChildrenByTagAndDataAttribute(html_selectedParticelleHtmlList,"li",config_ol.html_page_elments.form_list_element_partkey,t)}}var html_selectedFoglioTitolo,html_selectedParticelleHtmlList,html_fogli_DropDownList,html_mappali_DropDownList,html_mappali_DropDownList_empty,html_selectionBlockDiv,navigation,layersProgetto,html_buttonReset,html_buttonConfirm,map=void 0;function run(){navigation={intersectionPoint:void 0,seLectedFoglio:void 0,selectedParticelle:[]},html_selectionBlockDiv=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.selection_block_div),html_selectedFoglioTitolo=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.selected_foglio_div),html_selectedParticelleHtmlList=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.selected_particelle_div),html_fogli_DropDownList=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.fogli_input_select),html_mappali_DropDownList=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.mappali_input_select),html_mappali_DropDownList_empty=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.mappali_input_select_alt_txt),html_buttonConfirm=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.button_confirm_selection),html_buttonReset=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.button_reset_selection),layersProgetto=createMapLayers();var e={controls:ol.control.defaults().extend([new ol.control.FullScreen({source:"fullscreen"})]),layers:new ol.layer.Group({title:"Livelli di Base",layers:[layersProgetto.tms,layersProgetto.layer_carto_base,layersProgetto.layer_perimetro_comunale]}),target:config_ol.html_page_elments.map_div,view:new ol.View({projection:config_ol.projection,center:config_ol.territory_center_point,zoom:config_ol.initial_zoom,minZoom:config_ol.min_zoom,maxZoom:config_ol.max_zoom,extent:config_ol.tms_extent})};(map=new ol.Map(e)).addLayer(layersProgetto.layer_catasto_fogli),map.addLayer(layersProgetto.layer_catasto_particelle),map.addLayer(layersProgetto.layer_vett_foglio),map.addLayer(layersProgetto.layer_vett_particelle),map.on("click",onMapClick),catastoUtils.loadAllFogli(initializeFormAndMap)}